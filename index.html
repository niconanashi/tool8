<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ニコ生CMメーカー 制作ツール</title>
	<!-- 必須ライブラリ -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
	<style>
		body { font-family: sans-serif; background-color: #f0f4f8; padding: 20px; display: flex; flex-direction: column; align-items: center; }
		.card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 900px; }
		h1 { font-size: 40px; color: #2d3748; display: flex; align-items: center; justify-content: center; gap: 15px; margin: 0 0 20px 0; line-height: 1; }
		.title-icon { width: 100px; height: 100px; object-fit: contain; display: block; }
		.controls { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; background: #edf2f7; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
		.input-group { display: flex; flex-direction: column; gap: 5px; font-size: 13px; }
		input { padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; }
		input[type="color"] { height: 35px; cursor: pointer; padding: 2px; }
		
		.image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; border: 1px solid #eee; padding: 10px; }
		.image-item { position: relative; background: #fff; border: 2px solid #cbd5e0; border-radius: 8px; padding: 5px; cursor: grab; text-align: center; }
		.image-item img { width: 100%; height: 85px; object-fit: contain; background: #333; border-radius: 4px; }
		.image-label { font-size: 11px; margin-top: 5px; font-weight: bold; color: #4a5568; }

		.btn-del { position: absolute; top: -8px; right: -8px; background: #e53e3e; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-weight: bold; z-index: 5; }
		.btn-add { background: #3182ce; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
		
		#downloadZip { background: #48bb78; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; }
		#status { margin: 15px 0; color: #2b6cb0; font-weight: bold; text-align: center; }
	</style>
</head>
<body>

<div class="card">
	<h1>
		<img src="icon.png" alt="icon" class="title-icon">
		ニコ生CMメーカー 制作ツール
 	</h1>
	
	<div class="controls">
		<div class="input-group">
			<label>全体の再生時間(秒)</label>
			<input type="number" id="totalDuration" value="90">
		</div>
		<div class="input-group">
			<label>フェードイン速度 (0.01〜0.1)</label>
			<input type="number" id="fadeIn" value="0.02" step="0.01">
		</div>
		<div class="input-group">
			<label>終了メッセージ内容</label>
			<input type="text" id="endText" value="ご視聴ありがとうございました">
		</div>
		<div class="input-group">
			<label>メッセージの色</label>
			<input type="color" id="textColor" value="#ffffff">
		</div>
	</div>

	<div style="text-align: center;">
		<button class="btn-add" onclick="document.getElementById('bulk-input').click()">画像を追加 (1280x720)</button>
		<input type="file" id="bulk-input" style="display:none" multiple accept="image/*">
		<p style="font-size: 12px; color: #666;">ドラッグで並び替え / 画像クリックで差し替え</p>
	</div>

	<div id="image-grid" class="image-grid"></div>
	<div id="status">起動中...</div>
	<button id="downloadZip">game.zip を作成・ダウンロード</button>
</div>

<input type="file" id="replace-input" style="display:none" accept="image/*">

<script>
	const gridEl = document.getElementById('image-grid');
	const status = document.getElementById('status');
	const replaceInput = document.getElementById('replace-input');

	let imageList = []; // { id, blob, url }
	let replaceTargetId = null;

	// --- 初期化: a.png ～ t.png を読み込む ---
	(async () => {
		status.innerText = "初期画像を読み込んでいます...";
		const letters = "abcdefghijklmnopqrst".split("");
		for (const char of letters) {
			try {
				const path = `./game/files/${char}.png`;
				const res = await fetch(path);
				if (res.ok) {
					const blob = await res.blob();
					const item = { id: Math.random(), blob: blob, url: URL.createObjectURL(blob) };
					imageList.push(item);
					renderItem(item);
				}
			} catch (e) { console.warn(char + ".png is missing"); }
		}
		status.innerText = "読み込み完了。";
		updateLabels();
	})();

	function renderItem(item) {
		const div = document.createElement('div');
		div.className = 'image-item';
		div.dataset.id = item.id;
		div.innerHTML = `
			<button class="btn-del" onclick="deleteImage(${item.id})">×</button>
			<img src="${item.url}" onclick="triggerReplace(${item.id})">
			<div class="image-label"></div>
		`;
		gridEl.appendChild(div);
	}

	function updateLabels() {
		const labels = gridEl.querySelectorAll('.image-label');
		labels.forEach((el, i) => el.innerText = `${i + 1}枚目`);
	}

	Sortable.create(gridEl, {
		animation: 150,
		onEnd: () => {
			const newOrder = [];
			gridEl.querySelectorAll('.image-item').forEach(el => {
				const id = parseFloat(el.dataset.id);
				newOrder.push(imageList.find(img => img.id === id));
			});
			imageList = newOrder;
			updateLabels();
		}
	});

	// --- 操作ロジック ---
	function deleteImage(id) {
		imageList = imageList.filter(img => img.id !== id);
		gridEl.querySelector(`[data-id="${id}"]`).remove();
		updateLabels();
	}

	function triggerReplace(id) {
		replaceTargetId = id;
		replaceInput.click();
	}

	replaceInput.onchange = (e) => {
		const file = e.target.files[0];
		if (!file) return;
		const img = new Image();
		img.onload = () => {
			if (img.width === 1280 && img.height === 720) {
				const idx = imageList.findIndex(img => img.id === replaceTargetId);
				imageList[idx].blob = file;
				imageList[idx].url = URL.createObjectURL(file);
				gridEl.querySelector(`[data-id="${replaceTargetId}"] img`).src = imageList[idx].url;
			} else { alert("1280x720サイズのみです"); }
		};
		img.src = URL.createObjectURL(file);
	};

	document.getElementById('bulk-input').onchange = (e) => {
		Array.from(e.target.files).forEach(file => {
			const img = new Image();
			img.onload = () => {
				if (img.width === 1280 && img.height === 720) {
					const item = { id: Math.random(), blob: file, url: URL.createObjectURL(file) };
					imageList.push(item);
					renderItem(item);
					updateLabels();
				}
			};
			img.src = URL.createObjectURL(file);
		});
	};

	// --- ZIP作成 ---
	document.getElementById('downloadZip').onclick = async () => {
		if (imageList.length === 0) { alert("画像がありません"); return; }
		status.innerText = "ZIP作成中...";
		
		const zip = new JSZip();
		const imageIds = imageList.map((_, i) => String.fromCharCode(97 + i));
		const durationMs = parseInt(document.getElementById('totalDuration').value) * 1000;
		const endTextValue = document.getElementById('endText').value;
		const textColorValue = document.getElementById('textColor').value;

		// 1. game.json 作成
		const gameJson = {
			width: 1280, height: 720, fps: 30,
			main: "./script/main.js",
			assets: {
				bgm: { type: "audio", path: "files/bgm", systemId: "sound", duration: durationMs, hint: { extensions: [".m4a", ".ogg"] } },
				aez_asset_bundle: { type: "script", global: true, path: "files/main.js", virtualPath: "script/aez_asset_bundle.js" }
			},
			environment: { "sandbox-runtime": "3", nicolive: { supportedModes: ["ranking"], preferredSessionParameters: { totalTimeLimit: (durationMs/1000) + 10 } } },
			assetBundle: "./script/aez_asset_bundle.js"
		};
		imageIds.forEach(id => { gameJson.assets[id] = { type: "image", path: `files/${id}.png`, width: 1280, height: 720 }; });
		zip.file("game.json", JSON.stringify(gameJson, null, 2));

		// 2. main.js 生成
		const mainJs = `
module.exports={assets:{"main": {type:"script",path:"script/main.js",global:true,execute: rv => {
'use strict';
function main(param) {
  var TOTAL_MUSIC_DURATION = ${durationMs};
  var MAX_IMAGES = ${imageList.length};
  var FADE_SPEED = ${document.getElementById('fadeIn').value};
  var IMAGE_IDS = ${JSON.stringify(imageIds)};
  var END_MESSAGE = "${endTextValue.replace(/"/g, '\\"')}";
  var TEXT_COLOR = "${textColorValue}";

  var timePerImage = TOTAL_MUSIC_DURATION / MAX_IMAGES;
  var calculatedDuration = timePerImage - (1/FADE_SPEED * (1000/30));
  if (calculatedDuration < 0) calculatedDuration = 0;

  var scene = new g.Scene({ game: g.game, assetPaths: ["/**/*"] });
  scene.onLoad.add(function () {
    if (scene.asset.getAudioById("bgm")) scene.asset.getAudioById("bgm").play();
    var currentIndex = 0; var currentSprite = null;

    function showNextSlide() {
      if (currentIndex >= MAX_IMAGES) {
        var maxFontSize = 60;
        var maxWidth = 1200;
        var font = new g.DynamicFont({ game: g.game, fontFamily: "sans-serif", size: maxFontSize });
        var label = new g.Label({
          scene: scene, font: font, text: END_MESSAGE,
          x: 640, y: 360, anchorX: 0.5, anchorY: 0.5,
          textColor: TEXT_COLOR, parent: scene
        });
        // 画面はみ出し防止ロジック
        if (label.width > maxWidth) {
          label.fontSize = maxFontSize * (maxWidth / label.width);
          label.invalidate();
        }
        return;
      }
      var nextSprite = new g.Sprite({ scene: scene, src: scene.asset.getImageById(IMAGE_IDS[currentIndex]), opacity: currentIndex === 0 ? 1 : 0, parent: scene });
      if (currentIndex === 0) { currentSprite = nextSprite; startTimer(timePerImage); } 
      else {
        var prevSprite = currentSprite;
        nextSprite.onUpdate.add(function () {
          if (nextSprite.opacity < 1) {
            nextSprite.opacity += FADE_SPEED;
            if (nextSprite.opacity > 1) nextSprite.opacity = 1;
            nextSprite.modified();
          } else {
            nextSprite.onUpdate.removeAll();
            prevSprite.onUpdate.add(function () {
              prevSprite.opacity -= 0.1;
              if (prevSprite.opacity <= 0) { prevSprite.destroy(); } else { prevSprite.modified(); }
            });
            currentSprite = nextSprite;
            startTimer(calculatedDuration);
          }
        });
      }
    }
    function startTimer(duration) { scene.setTimeout(function () { currentIndex++; showNextSlide(); }, duration); }
    showNextSlide();
  });
  g.game.pushScene(scene);
}
module.exports = main;
return module.exports;
},},"data": {type:"text",path:"text/data.json",data: \`{}\`,},}}`;

		zip.file("files/main.js", mainJs);

		// 3. 既存の音声ファイルをコピー
		try {
			const [bgmA, bgmO] = await Promise.all([
				fetch('./game/files/bgm.m4a').then(r => r.blob()),
				fetch('./game/files/bgm.ogg').then(r => r.blob())
			]);
			zip.file("files/bgm.m4a", bgmA);
			zip.file("files/bgm.ogg", bgmO);
		} catch(e) { console.warn("BGM missing"); }

		// 4. 画像追加
		imageList.forEach((img, i) => { zip.file(`files/${imageIds[i]}.png`, img.blob); });

		const content = await zip.generateAsync({ type: "blob" });
		saveAs(content, "cm_maker.zip");
		status.innerText = "作成完了！";
	};
</script>

</body>
</html>
