<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>環境診断テスト</title>
    <!-- ライブラリ読み込みテスト -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: monospace; background: #222; color: #0f0; padding: 20px; line-height: 1.5; }
        .success { color: #0f0; }
        .error { color: #f00; font-weight: bold; }
        .warning { color: #ff0; }
        hr { border: 1px solid #444; }
    </style>
</head>
<body>
    <h1>CMメーカー 環境診断ツール</h1>
    <div id="log">テスト開始...<br></div>

    <script>
        const logEl = document.getElementById('log');
        function log(msg, type = '') {
            const span = document.createElement('span');
            span.innerHTML = msg + '<br>';
            if (type) span.className = type;
            logEl.appendChild(span);
        }

        async function runDiagnostic() {
            // 1. ライブラリ存在チェック
            log("--- [1] ライブラリ存在チェック ---");
            if (typeof FFmpeg !== 'undefined') log("OK: FFmpeg.js 読み込み完了", "success");
            else log("NG: FFmpeg.js が見つかりません", "error");

            if (typeof JSZip !== 'undefined') log("OK: JSZip 読み込み完了", "success");
            else log("NG: JSZip が見つかりません", "error");

            if (typeof saveAs !== 'undefined') log("OK: FileSaver.js 読み込み完了", "success");
            else log("NG: FileSaver.js が見つかりません", "error");

            log("<hr>");

            // 2. ファイルパス（fetch）チェック
            log("--- [2] 外部ファイル読み込みテスト ---");
            const filesToTest = [
                'game/files/a.png',
                'game/files/bgm.m4a',
                'game/files/bgm.ogg'
            ];

            for (let path of filesToTest) {
                try {
                    const res = await fetch(path);
                    if (res.ok) log(`OK: ${path} にアクセス可能 (${res.status})`, "success");
                    else log(`NG: ${path} が見つかりません (${res.status})`, "error");
                } catch (e) {
                    log(`NG: ${path} への fetch がブロックされました (CORSエラー等の可能性)`, "error");
                }
            }

            log("<hr>");

            // 3. FFmpeg ロードテスト
            log("--- [3] FFmpeg コアロードテスト ---");
            try {
                const { createFFmpeg } = FFmpeg;
                const ffmpeg = createFFmpeg({ 
                    log: true, 
                    corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js' 
                });
                
                log("コアをダウンロード中...");
                await ffmpeg.load();
                log("OK: FFmpegコアの初期化に成功しました！", "success");
            } catch (e) {
                log("NG: FFmpegコアのロードに失敗しました。", "error");
                log(`理由: ${e.message}`);
                if (window.crossOriginIsolated === false) {
                    log("原因候補: Cross-Origin Isolation が有効ではありません。サーバーのヘッダー設定(COOP/COEP)が必要です。", "warning");
                }
            }

            log("<hr>");
            log("診断終了。");
        }

        runDiagnostic();
    </script>
</body>
</html>
