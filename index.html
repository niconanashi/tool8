<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ニコ生CMメーカー作成ツール</title>
	<!-- 安定動作するライブラリ群 -->
	<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
	<!-- 並び替え用ライブラリ -->
	<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
	<style>
		body {
			font-family: 'Segoe UI', Tahoma, sans-serif;
			background-color: #f0f4f8;
			color: #333;
			display: flex;
			flex-direction: column;
			align-items: center;
			padding: 20px;
		}
		.card {
			background: white;
			padding: 25px;
			border-radius: 15px;
			box-shadow: 0 10px 25px rgba(0,0,0,0.1);
			width: 100%;
			max-width: 900px;
		}
		h1 { color: #2d3748; text-align: center; font-size: 24px; }
		.config-section {
			display: flex;
			flex-wrap: wrap;
			gap: 15px;
			background: #edf2f7;
			padding: 15px;
			border-radius: 10px;
			margin-bottom: 20px;
		}
		.input-item { display: flex; flex-direction: column; gap: 5px; }
		input[type="number"] { width: 80px; padding: 5px; border-radius: 5px; border: 1px solid #cbd5e0; }
		
		/* 画像グリッドエリア */
		.image-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
			gap: 15px;
			margin: 20px 0;
			min-height: 200px;
		}
		.image-item {
			position: relative;
			background: #fff;
			border: 2px solid #e2e8f0;
			border-radius: 8px;
			padding: 5px;
			cursor: grab;
			transition: transform 0.2s;
		}
		.image-item:active { cursor: grabbing; }
		.image-item img {
			width: 100%;
			height: 90px;
			object-fit: contain;
			background: #eee;
			border-radius: 4px;
			display: block;
		}
		.image-label {
			font-size: 12px;
			text-align: center;
			margin-top: 5px;
			font-weight: bold;
			color: #4a5568;
		}
		
		/* 操作ボタン */
		.btn-delete {
			position: absolute;
			top: -8px;
			right: -8px;
			background: #e53e3e;
			color: white;
			border: none;
			border-radius: 50%;
			width: 24px;
			height: 24px;
			cursor: pointer;
			font-weight: bold;
			z-index: 10;
		}
		.btn-add {
			background: #3182ce;
			color: white;
			padding: 10px 20px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-weight: bold;
			margin-bottom: 20px;
		}
		#downloadZip {
			background: #48bb78;
			color: white;
			padding: 15px;
			border: none;
			border-radius: 10px;
			width: 100%;
			font-size: 18px;
			font-weight: bold;
			cursor: pointer;
			display: none;
		}
		#status {
			margin: 15px 0;
			font-weight: bold;
			color: #2b6cb0;
			text-align: center;
		}
		.instructions { font-size: 14px; color: #718096; text-align: center; margin-bottom: 10px; }
	</style>
</head>
<body>

<div class="card">
	<h1>ニコ生CMメーカー 制作ツール</h1>
	<p class="instructions">画像をドラッグして並び替え / 画像をクリックして個別に差し替え</p>

	<div class="config-section">
		<div class="input-item">
			<label>フェードイン速度</label>
			<input type="number" id="fadeInSpeed" value="0.02" step="0.01" min="0.01">
		</div>
		<div class="input-item">
			<label>フェードアウト速度</label>
			<input type="number" id="fadeOutSpeed" value="0.1" step="0.01" min="0.01">
		</div>
		<div class="input-item" style="flex-grow: 1;">
			<label>BGMを選択 (m4a/oggへ自動変換)</label>
			<input type="file" id="audio-input" accept="audio/*">
		</div>
	</div>

	<div style="text-align:center;">
		<button class="btn-add" onclick="document.getElementById('bulk-image-input').click()">画像を追加 (1280x720)</button>
		<input type="file" id="bulk-image-input" style="display:none" multiple accept="image/*">
	</div>

	<div id="image-grid" class="image-grid">
		<!-- ここに画像スロットが表示されます -->
	</div>

	<div id="status">FFmpegを準備中...</div>
	<button id="downloadZip">game.zip を作成してダウンロード</button>
</div>

<!-- 差し替え用の隠しinput -->
<input type="file" id="replace-input" style="display:none" accept="image/*">

<script>
	const { createFFmpeg, fetchFile } = FFmpeg;
	const gridEl = document.getElementById('image-grid');
	const status = document.getElementById('status');
	const downloadBtn = document.getElementById('downloadZip');
	const replaceInput = document.getElementById('replace-input');

	// FFmpeg初期化 (安定スレッド版コアを指定)
	const ffmpeg = createFFmpeg({
		log: true,
		corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
	});

	let bgmData = { m4a: null, ogg: null, duration: 0 };
	let imageList = []; // { id, blob, url }
	let currentReplaceId = null;

	(async () => {
		try {
			await ffmpeg.load();
			status.innerText = "初期画像をロード中...";
			await loadInitialImages();
		} catch (e) {
			status.innerHTML = "<span style='color:red'>エラー: FFmpegの読み込みに失敗しました。再読み込みしてください。</span>";
		}
	})();

	// 初期画像(a.png〜t.png)をリポジトリから読み込む
	async function loadInitialImages() {
		const alphabet = "abcdefghijklmnopqrst".split("");
		for (const char of alphabet) {
			try {
				const response = await fetch(`game/files/${char}.png`);
				if (!response.ok) continue;
				const blob = await response.blob();
				addImageToList(blob);
			} catch (e) {
				console.log("Initial image load error: ", char);
			}
		}
		status.innerText = "準備完了！";
		checkReady();
	}

	// 画像リストへの追加処理
	function addImageToList(blob) {
		const img = new Image();
		const url = URL.createObjectURL(blob);
		img.onload = () => {
			if (img.width === 1280 && img.height === 720) {
				const item = { id: Math.random(), blob: blob, url: url };
				imageList.push(item);
				renderItem(item);
			} else {
				alert("1280x720以外の画像は読み込めません。");
			}
		};
		img.src = url;
	}

	// 画面描画
	function renderItem(item) {
		const div = document.createElement('div');
		div.className = 'image-item';
		div.dataset.id = item.id;
		div.innerHTML = `
			<button class="btn-delete" onclick="deleteImage(${item.id})">×</button>
			<img src="${item.url}" onclick="triggerReplace(${item.id})">
			<div class="image-label"></div>
		`;
		gridEl.appendChild(div);
		updateLabels();
	}

	function updateLabels() {
		const labels = gridEl.querySelectorAll('.image-label');
		labels.forEach((el, i) => el.innerText = `${i + 1}枚目`);
	}

	// 並び替え有効化
	Sortable.create(gridEl, {
		animation: 150,
		onEnd: () => {
			const newOrder = [];
			gridEl.querySelectorAll('.image-item').forEach(el => {
				const id = parseFloat(el.dataset.id);
				newOrder.push(imageList.find(img => img.id === id));
			});
			imageList = newOrder;
			updateLabels();
		}
	});

	// --- 操作関数 ---

	function deleteImage(id) {
		imageList = imageList.filter(img => img.id !== id);
		const el = gridEl.querySelector(`[data-id="${id}"]`);
		if (el) el.remove();
		updateLabels();
		checkReady();
	}

	function triggerReplace(id) {
		currentReplaceId = id;
		replaceInput.click();
	}

	replaceInput.onchange = (e) => {
		const file = e.target.files[0];
		if (!file) return;
		const img = new Image();
		const url = URL.createObjectURL(file);
		img.onload = () => {
			if (img.width === 1280 && img.height === 720) {
				const index = imageList.findIndex(img => img.id === currentReplaceId);
				imageList[index].blob = file;
				imageList[index].url = url;
				const imgTag = gridEl.querySelector(`[data-id="${currentReplaceId}"] img`);
				imgTag.src = url;
			} else {
				alert("1280x720サイズのみ許可されています。");
			}
		};
		img.src = url;
	};

	document.getElementById('bulk-image-input').onchange = (e) => {
		Array.from(e.target.files).forEach(file => addImageToList(file));
	};

	// --- 音声変換ロジック (提供された安定版を流用) ---

	document.getElementById('audio-input').onchange = async (e) => {
		const file = e.target.files[0];
		if (!file || !ffmpeg.isLoaded()) return;

		downloadBtn.style.display = 'none';
		status.innerText = "音声変換中...時間がかかる場合があります";
		
		try {
			// 再生時間の取得
			const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
			const buffer = await file.arrayBuffer();
			const decoded = await audioCtx.decodeAudioData(buffer);
			bgmData.duration = Math.floor(decoded.duration * 1000);

			// 仮想FSに書き込み
			ffmpeg.FS('writeFile', 'bgm_tmp', await fetchFile(file));

			// M4A変換
			status.innerHTML = "AAC (M4A) に変換中...";
			await ffmpeg.run('-i', 'bgm_tmp', '-c:a', 'aac', '-b:a', '128k', '-movflags', '+faststart', 'out.m4a');
			bgmData.m4a = ffmpeg.FS('readFile', 'out.m4a');

			// OGG変換
			status.innerHTML = "OGGに変換中...";
			await ffmpeg.run('-i', 'bgm_tmp', '-c:a', 'libvorbis', '-q:a', '4', 'out.ogg');
			bgmData.ogg = ffmpeg.FS('readFile', 'out.ogg');

			status.innerText = `音声準備完了 (${(bgmData.duration/1000).toFixed(1)}秒)`;
			checkReady();
		} catch (err) {
			console.error(err);
			status.innerHTML = "<span style='color:red'>音声の変換に失敗しました。</span>";
		}
	};

	function checkReady() {
		if (bgmData.m4a && imageList.length > 0) {
			downloadBtn.style.display = 'block';
		}
	}

	// --- ZIP作成と変数書き換え ---

	downloadBtn.onclick = async () => {
		status.innerText = "ZIPアーカイブを作成中...";
		const zip = new JSZip();
		const imageIds = imageList.map((_, i) => String.fromCharCode(97 + i)); // a, b, c...

		// 1. game.json 作成
		const gameJson = {
			width: 1280, height: 720, fps: 30,
			main: "./script/main.js",
			assets: {
				bgm: {
					type: "audio", path: "files/bgm", systemId: "sound",
					duration: bgmData.duration, hint: { extensions: [".m4a", ".ogg"] }
				},
				aez_asset_bundle: {
					type: "script", global: true, path: "files/main.js", virtualPath: "script/aez_asset_bundle.js"
				}
			},
			environment: {
				"sandbox-runtime": "3",
				nicolive: { supportedModes: ["ranking"], preferredSessionParameters: { totalTimeLimit: Math.ceil(bgmData.duration / 1000) + 5 } }
			},
			assetBundle: "./script/aez_asset_bundle.js"
		};
		// 画像アセットを動的に追加
		imageIds.forEach(id => {
			gameJson.assets[id] = { type: "image", path: `files/${id}.png`, width: 1280, height: 720 };
		});
		zip.file("game.json", JSON.stringify(gameJson, null, "\t"));

		// 2. main.js 作成 (入力値を反映)
		const mainJsContent = `
module.exports={assets:{"main": {type:"script",path:"script/main.js",global:true,execute: rv => {
'use strict';
function main(param) {
  var TOTAL_MUSIC_DURATION = ${bgmData.duration};
  var MAX_IMAGES = ${imageList.length};
  var FADE_SPEED = ${document.getElementById('fadeInSpeed').value};
  var FADE_SPEED2 = ${document.getElementById('fadeOutSpeed').value};
  var IMAGE_IDS = ${JSON.stringify(imageIds)};

  var timePerImage = TOTAL_MUSIC_DURATION / MAX_IMAGES;
  var fps = 30;
  var fadeTimeMs = 1 / FADE_SPEED * (1000 / fps);
  var calculatedDuration = timePerImage - fadeTimeMs;
  if (calculatedDuration < 0) calculatedDuration = 0;

  var scene = new g.Scene({ game: g.game, assetPaths: ["/**/*"] });
  scene.onLoad.add(function () {
    if (scene.asset.getAudioById("bgm")) scene.asset.getAudioById("bgm").play();
    var currentIndex = 0;
    var currentSprite = null;

    function showNextSlide() {
      if (currentIndex >= MAX_IMAGES) {
        var font = new g.DynamicFont({ game: g.game, fontFamily: "sans-serif", size: 60 });
        new g.Label({ scene: scene, font: font, text: "ご視聴ありがとうございました", x: 640, y: 360, anchorX: 0.5, anchorY: 0.5, textColor: "white", parent: scene });
        return;
      }
      var nextSprite = new g.Sprite({ scene: scene, src: scene.asset.getImageById(IMAGE_IDS[currentIndex]), opacity: currentIndex === 0 ? 1 : 0, parent: scene });
      if (currentIndex === 0) { currentSprite = nextSprite; startTimer(timePerImage); } 
      else {
        var prevSprite = currentSprite;
        nextSprite.onUpdate.add(function () {
          if (nextSprite.opacity < 1) {
            nextSprite.opacity += FADE_SPEED;
            if (nextSprite.opacity > 1) nextSprite.opacity = 1;
            nextSprite.modified();
          } else {
            nextSprite.onUpdate.removeAll();
            prevSprite.onUpdate.add(function () {
              prevSprite.opacity -= FADE_SPEED2;
              if (prevSprite.opacity <= 0) { prevSprite.destroy(); } else { prevSprite.modified(); }
            });
            currentSprite = nextSprite;
            startTimer(calculatedDuration);
          }
        });
      }
    }
    function startTimer(duration) { scene.setTimeout(function () { currentIndex++; showNextSlide(); }, duration); }
    showNextSlide();
  });
  g.game.pushScene(scene);
}
module.exports = main;
return module.exports;
},},"data": {type:"text",path:"text/data.json",data: \`{}\`,},}}`;

		zip.file("files/main.js", mainJsContent);

		// 3. 各ファイルをZIPに追加
		zip.file("files/bgm.m4a", bgmData.m4a);
		zip.file("files/bgm.ogg", bgmData.ogg);
		imageList.forEach((img, i) => {
			zip.file(`files/${imageIds[i]}.png`, img.blob);
		});

		const content = await zip.generateAsync({ type: "blob" });
		saveAs(content, "game.zip");
		status.innerText = "ダウンロードが開始されました！";
	};
</script>

</body>
</html>
